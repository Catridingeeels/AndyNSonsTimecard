<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Andy & Sons Timecard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #16a34a;
            --success-dark: #15803d;
            --danger: #dc2626;
            --danger-dark: #b91c1c;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-500: #6b7280;
            --gray-700: #374151;
            --gray-900: #111827;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gray-100);
            min-height: 100vh;
            color: var(--gray-900);
        }

        /* Header */
        .header {
            background: var(--primary);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .header-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            cursor: pointer;
        }

        /* Navigation */
        .nav {
            display: flex;
            background: white;
            border-bottom: 1px solid var(--gray-200);
        }

        .nav-btn {
            flex: 1;
            padding: 0.75rem;
            border: none;
            background: none;
            font-size: 0.875rem;
            color: var(--gray-500);
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .nav-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            font-weight: 600;
        }

        /* Views */
        .view {
            display: none;
            padding: 1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .view.active {
            display: block;
        }

        /* Timer View */
        .timer-display {
            text-align: center;
            padding: 2rem 0;
        }

        .current-date {
            color: var(--gray-500);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .timer-time {
            font-size: 3.5rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            margin-bottom: 0.5rem;
        }

        .timer-status {
            font-size: 1rem;
            color: var(--gray-500);
            margin-bottom: 1rem;
        }

        .timer-status.running {
            color: var(--success);
            font-weight: 600;
        }

        .timer-btn {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            border: none;
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
            cursor: pointer;
            margin: 1rem auto;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 14px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }

        .timer-btn:active {
            transform: scale(0.95);
        }

        .timer-btn.start {
            background: var(--success);
        }

        .timer-btn.stop {
            background: var(--danger);
        }

        /* Work Type Selector */
        .type-selector {
            margin: 1.5rem 0;
        }

        .type-selector label {
            display: block;
            font-size: 0.875rem;
            color: var(--gray-500);
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .type-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .type-btn {
            padding: 0.75rem 0.5rem;
            border: 2px solid var(--gray-200);
            background: white;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .type-btn.selected {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary);
            font-weight: 600;
        }

        /* Today's Entries */
        .section-title {
            font-size: 1rem;
            font-weight: 600;
            margin: 1.5rem 0 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .add-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.4rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .entry-list {
            background: white;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .entry-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--gray-100);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .entry-item:last-child {
            border-bottom: none;
        }

        .entry-info {
            flex: 1;
        }

        .entry-type {
            font-weight: 500;
            font-size: 0.875rem;
        }

        .entry-time {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .entry-duration {
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--primary);
            margin-right: 0.75rem;
        }

        .entry-actions {
            display: flex;
            gap: 0.25rem;
        }

        .entry-actions button {
            background: none;
            border: none;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .entry-actions button:hover {
            color: var(--gray-900);
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--gray-500);
        }

        /* Finish Day Button */
        .finish-day-btn {
            width: 100%;
            padding: 1rem;
            background: var(--gray-700);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1.5rem;
        }

        /* History View */
        .date-picker {
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .date-picker input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.375rem;
            font-size: 1rem;
        }

        .day-summary {
            background: white;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .day-summary h3 {
            font-size: 0.875rem;
            color: var(--gray-500);
            margin-bottom: 0.5rem;
        }

        .day-total {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .day-notes {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
        }

        .day-notes textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.375rem;
            font-size: 0.875rem;
            resize: vertical;
            min-height: 80px;
        }

        .save-notes-btn {
            margin-top: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            cursor: pointer;
        }

        /* Reports View */
        .report-form {
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.375rem;
            font-size: 1rem;
        }

        .generate-btn {
            width: 100%;
            padding: 1rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 0.75rem;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.125rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-500);
        }

        .modal-body {
            padding: 1rem;
        }

        .modal-footer {
            padding: 1rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            gap: 0.5rem;
        }

        .modal-footer button {
            flex: 1;
            padding: 0.75rem;
            border-radius: 0.375rem;
            font-size: 1rem;
            cursor: pointer;
        }

        .btn-cancel {
            background: var(--gray-200);
            border: none;
            color: var(--gray-700);
        }

        .btn-save {
            background: var(--primary);
            border: none;
            color: white;
        }

        .btn-delete {
            background: var(--danger);
            border: none;
            color: white;
        }

        /* Photo Feature Styles */
        .section-title-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .camera-btn {
            background: var(--gray-700);
            color: white;
            border: none;
            padding: 0.4rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .photo-thumbnail {
            aspect-ratio: 1;
            border-radius: 0.375rem;
            overflow: hidden;
            cursor: pointer;
            position: relative;
        }

        .photo-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-thumbnail .photo-note-preview {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            font-size: 0.625rem;
            padding: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .photo-section {
            margin-top: 1rem;
        }

        .photo-section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        .no-photos {
            text-align: center;
            padding: 1rem;
            color: var(--gray-500);
            font-size: 0.875rem;
            background: white;
            border-radius: 0.5rem;
        }

        /* Photo Capture Modal */
        .photo-preview-container {
            width: 100%;
            aspect-ratio: 4/3;
            background: var(--gray-100);
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .photo-preview-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .photo-preview-placeholder {
            color: var(--gray-500);
            font-size: 0.875rem;
        }

        .photo-input-label {
            display: block;
            width: 100%;
            padding: 0.75rem;
            background: var(--primary);
            color: white;
            text-align: center;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .photo-input-label:hover {
            background: var(--primary-dark);
        }

        #photo-file-input {
            display: none;
        }

        /* Photo View Modal */
        .photo-view-container {
            width: 100%;
            max-height: 60vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gray-900);
            border-radius: 0.375rem;
            overflow: hidden;
        }

        .photo-view-container img {
            max-width: 100%;
            max-height: 60vh;
            object-fit: contain;
        }

        .photo-view-note {
            margin-top: 1rem;
            padding: 0.75rem;
            background: var(--gray-100);
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }

        .photo-view-note label {
            display: block;
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-bottom: 0.25rem;
        }

        .photo-view-timestamp {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>Andy & Sons</h1>
        <button class="header-btn" onclick="exportData()">Backup</button>
    </header>

    <nav class="nav">
        <button class="nav-btn active" data-view="timer">Timer</button>
        <button class="nav-btn" data-view="history">History</button>
        <button class="nav-btn" data-view="reports">Reports</button>
    </nav>

    <!-- Timer View -->
    <div id="timer-view" class="view active">
        <div class="timer-display">
            <div class="current-date" id="current-date"></div>
            <div class="timer-time" id="timer-time">00:00:00</div>
            <div class="timer-status" id="timer-status">Ready to start</div>
            <button class="timer-btn start" id="timer-btn" onclick="toggleTimer()">START</button>
        </div>

        <div class="type-selector">
            <label>Work Type</label>
            <div class="type-grid" id="type-grid"></div>
        </div>

        <div class="section-title">
            <span>Today's Entries</span>
            <div class="section-title-buttons">
                <button class="camera-btn" onclick="openPhotoCapture()">ðŸ“· Photo</button>
                <button class="add-btn" onclick="openAddEntry()">+ Add</button>
            </div>
        </div>
        <div class="entry-list" id="today-entries"></div>

        <div class="photo-section">
            <div class="photo-section-title">Today's Photos</div>
            <div id="today-photos"></div>
        </div>

        <button class="finish-day-btn" onclick="finishDay()">Finish Day</button>
    </div>

    <!-- History View -->
    <div id="history-view" class="view">
        <div class="date-picker">
            <input type="date" id="history-date" onchange="loadHistoryDate()">
        </div>
        <div class="day-summary">
            <h3>Total Hours</h3>
            <div class="day-total" id="history-total">0.00 hrs</div>
            <div class="day-notes">
                <label style="font-size: 0.875rem; color: var(--gray-500);">Day Notes</label>
                <textarea id="history-notes" placeholder="Notes for this day..."></textarea>
                <button class="save-notes-btn" onclick="saveHistoryNotes()">Save Notes</button>
            </div>
        </div>
        <div class="section-title">
            <span>Entries</span>
            <div class="section-title-buttons">
                <button class="camera-btn" onclick="openPhotoCapture(document.getElementById('history-date').value)">ðŸ“· Photo</button>
                <button class="add-btn" onclick="openAddEntry(document.getElementById('history-date').value)">+ Add</button>
            </div>
        </div>
        <div class="entry-list" id="history-entries"></div>

        <div class="photo-section">
            <div class="photo-section-title">Photos</div>
            <div id="history-photos"></div>
        </div>
    </div>

    <!-- Reports View -->
    <div id="reports-view" class="view">
        <div class="report-form">
            <div class="form-group">
                <label>Start Date</label>
                <input type="date" id="report-start">
            </div>
            <div class="form-group">
                <label>End Date</label>
                <input type="date" id="report-end">
            </div>
            <button class="generate-btn" onclick="generatePDF()">Generate PDF Report</button>
        </div>
    </div>

    <!-- Entry Modal -->
    <div class="modal-overlay" id="entry-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modal-title">Add Entry</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="entry-date">
                </div>
                <div class="form-group">
                    <label>Start Time</label>
                    <input type="time" id="entry-start">
                </div>
                <div class="form-group">
                    <label>End Time</label>
                    <input type="time" id="entry-end">
                </div>
                <div class="form-group">
                    <label>Work Type</label>
                    <select id="entry-type"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal()">Cancel</button>
                <button class="btn-delete" id="delete-btn" onclick="deleteEntry()" style="display:none;">Delete</button>
                <button class="btn-save" onclick="saveEntry()">Save</button>
            </div>
        </div>
    </div>

    <!-- Photo Capture Modal -->
    <div class="modal-overlay" id="photo-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>Add Photo</h2>
                <button class="modal-close" onclick="closePhotoModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="photo-preview-container" id="photo-preview-container">
                    <span class="photo-preview-placeholder">No photo selected</span>
                </div>
                <label class="photo-input-label">
                    ðŸ“· Take Photo or Choose File
                    <input type="file" id="photo-file-input" accept="image/*" capture="environment" onchange="handlePhotoSelect(event)">
                </label>
                <div class="form-group">
                    <label>Note / Caption</label>
                    <input type="text" id="photo-note" placeholder="e.g., 123 Main St - before painting">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closePhotoModal()">Cancel</button>
                <button class="btn-save" onclick="savePhoto()">Save Photo</button>
            </div>
        </div>
    </div>

    <!-- Photo View Modal -->
    <div class="modal-overlay" id="photo-view-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>Photo</h2>
                <button class="modal-close" onclick="closePhotoViewModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="photo-view-container">
                    <img id="photo-view-image" src="" alt="Photo">
                </div>
                <div class="photo-view-note" id="photo-view-note-container">
                    <label>Note</label>
                    <div id="photo-view-note-text"></div>
                </div>
                <div class="photo-view-timestamp" id="photo-view-timestamp"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closePhotoViewModal()">Close</button>
                <button class="btn-delete" onclick="deletePhoto()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Finish Day Modal -->
    <div class="modal-overlay" id="finish-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>Finish Day</h2>
                <button class="modal-close" onclick="closeFinishModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem; color: var(--gray-500);">Add any notes about today's work:</p>
                <textarea id="finish-notes" style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 0.375rem; min-height: 100px;"></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeFinishModal()">Cancel</button>
                <button class="btn-save" onclick="saveFinishDay()">Save & Finish</button>
            </div>
        </div>
    </div>

    <script>
        // Work Types
        const WORK_TYPES = [
            'Landscape',
            'Floor and Counter',
            'Painting Exterior',
            'Interior Finish Carpentry',
            'Building Repair/Remodel',
            'Painting Interior',
            'Contractor Shop/cleaning',
            'Residential Cleaning'
        ];

        // State
        let state = {
            entries: [],
            dayNotes: {},
            photos: [],
            timerRunning: false,
            timerStart: null,
            selectedType: WORK_TYPES[0]
        };

        let timerInterval = null;
        let editingEntryId = null;
        let pendingPhotoData = null;
        let pendingPhotoDate = null;
        let viewingPhotoId = null;

        // Initialize
        function init() {
            loadState();
            renderTypeGrid();
            renderTypeSelect();
            updateDate();
            renderTodayEntries();
            renderTodayPhotos();
            setupNav();

            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('history-date').value = today;
            document.getElementById('report-start').value = today;
            document.getElementById('report-end').value = today;

            // Resume timer if was running
            if (state.timerRunning && state.timerStart) {
                startTimerDisplay();
            }

            // Update date every minute
            setInterval(updateDate, 60000);
        }

        // LocalStorage
        function loadState() {
            const saved = localStorage.getItem('andySonsTimecard');
            if (saved) {
                const parsed = JSON.parse(saved);
                state.entries = parsed.entries || [];
                state.dayNotes = parsed.dayNotes || {};
                state.photos = parsed.photos || [];
                state.timerRunning = parsed.timerRunning || false;
                state.timerStart = parsed.timerStart || null;
                state.selectedType = parsed.selectedType || WORK_TYPES[0];
            }
        }

        function saveState() {
            localStorage.setItem('andySonsTimecard', JSON.stringify(state));
        }

        // Navigation
        function setupNav() {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById(btn.dataset.view + '-view').classList.add('active');

                    if (btn.dataset.view === 'history') {
                        loadHistoryDate();
                    }
                    if (btn.dataset.view === 'timer') {
                        renderTodayPhotos();
                    }
                });
            });
        }

        // Date Display
        function updateDate() {
            const now = new Date();
            const options = { weekday: 'long', month: 'long', day: 'numeric' };
            document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', options);
        }

        // Type Grid
        function renderTypeGrid() {
            const grid = document.getElementById('type-grid');
            grid.innerHTML = WORK_TYPES.map(type => `
                <button class="type-btn ${state.selectedType === type ? 'selected' : ''}"
                        onclick="selectType('${type}')">${type}</button>
            `).join('');
        }

        function selectType(type) {
            // If timer is running, save current segment and start new one
            if (state.timerRunning) {
                saveCurrentSegment();
                state.timerStart = Date.now();
            }
            state.selectedType = type;
            saveState();
            renderTypeGrid();
            renderTodayEntries();
        }

        function renderTypeSelect() {
            const select = document.getElementById('entry-type');
            select.innerHTML = WORK_TYPES.map(type =>
                `<option value="${type}">${type}</option>`
            ).join('');
        }

        // Timer
        function toggleTimer() {
            if (state.timerRunning) {
                stopTimer();
            } else {
                startTimer();
            }
        }

        function startTimer() {
            state.timerRunning = true;
            state.timerStart = Date.now();
            saveState();
            startTimerDisplay();

            const btn = document.getElementById('timer-btn');
            btn.textContent = 'STOP';
            btn.classList.remove('start');
            btn.classList.add('stop');

            document.getElementById('timer-status').textContent = state.selectedType;
            document.getElementById('timer-status').classList.add('running');
        }

        function stopTimer() {
            saveCurrentSegment();

            state.timerRunning = false;
            state.timerStart = null;
            saveState();

            clearInterval(timerInterval);
            document.getElementById('timer-time').textContent = '00:00:00';

            const btn = document.getElementById('timer-btn');
            btn.textContent = 'START';
            btn.classList.remove('stop');
            btn.classList.add('start');

            document.getElementById('timer-status').textContent = 'Ready to start';
            document.getElementById('timer-status').classList.remove('running');

            renderTodayEntries();
        }

        function saveCurrentSegment() {
            if (!state.timerStart) return;

            const startDate = new Date(state.timerStart);
            const endDate = new Date();

            const entry = {
                id: generateId(),
                date: startDate.toISOString().split('T')[0],
                startTime: formatTime(startDate),
                endTime: formatTime(endDate),
                type: state.selectedType
            };

            state.entries.push(entry);
            saveState();
        }

        function startTimerDisplay() {
            updateTimerDisplay();
            timerInterval = setInterval(updateTimerDisplay, 1000);

            const btn = document.getElementById('timer-btn');
            btn.textContent = 'STOP';
            btn.classList.remove('start');
            btn.classList.add('stop');

            document.getElementById('timer-status').textContent = state.selectedType;
            document.getElementById('timer-status').classList.add('running');
        }

        function updateTimerDisplay() {
            if (!state.timerStart) return;
            const elapsed = Date.now() - state.timerStart;
            document.getElementById('timer-time').textContent = formatDuration(elapsed);
        }

        // Entry Management
        function renderTodayEntries() {
            const today = new Date().toISOString().split('T')[0];
            renderEntries('today-entries', today);
        }

        function renderEntries(containerId, date) {
            const container = document.getElementById(containerId);
            const entries = state.entries.filter(e => e.date === date).sort((a, b) =>
                a.startTime.localeCompare(b.startTime)
            );

            if (entries.length === 0) {
                container.innerHTML = '<div class="empty-state">No entries yet</div>';
                return;
            }

            container.innerHTML = entries.map(entry => `
                <div class="entry-item">
                    <div class="entry-info">
                        <div class="entry-type">${entry.type}</div>
                        <div class="entry-time">${entry.startTime} - ${entry.endTime}</div>
                    </div>
                    <div class="entry-duration">${calculateDuration(entry.startTime, entry.endTime)}</div>
                    <div class="entry-actions">
                        <button onclick="editEntry('${entry.id}')">Edit</button>
                    </div>
                </div>
            `).join('');
        }

        function openAddEntry(date = null) {
            editingEntryId = null;
            document.getElementById('modal-title').textContent = 'Add Entry';
            document.getElementById('delete-btn').style.display = 'none';

            const today = date || new Date().toISOString().split('T')[0];
            document.getElementById('entry-date').value = today;
            document.getElementById('entry-start').value = '';
            document.getElementById('entry-end').value = '';
            document.getElementById('entry-type').value = state.selectedType;

            document.getElementById('entry-modal').classList.add('active');
        }

        function editEntry(id) {
            const entry = state.entries.find(e => e.id === id);
            if (!entry) return;

            editingEntryId = id;
            document.getElementById('modal-title').textContent = 'Edit Entry';
            document.getElementById('delete-btn').style.display = 'block';

            document.getElementById('entry-date').value = entry.date;
            document.getElementById('entry-start').value = entry.startTime;
            document.getElementById('entry-end').value = entry.endTime;
            document.getElementById('entry-type').value = entry.type;

            document.getElementById('entry-modal').classList.add('active');
        }

        function saveEntry() {
            const date = document.getElementById('entry-date').value;
            const startTime = document.getElementById('entry-start').value;
            const endTime = document.getElementById('entry-end').value;
            const type = document.getElementById('entry-type').value;

            if (!date || !startTime || !endTime) {
                alert('Please fill in all fields');
                return;
            }

            if (editingEntryId) {
                const index = state.entries.findIndex(e => e.id === editingEntryId);
                if (index !== -1) {
                    state.entries[index] = { ...state.entries[index], date, startTime, endTime, type };
                }
            } else {
                state.entries.push({
                    id: generateId(),
                    date,
                    startTime,
                    endTime,
                    type
                });
            }

            saveState();
            closeModal();
            renderTodayEntries();
            loadHistoryDate();
        }

        function deleteEntry() {
            if (!editingEntryId) return;
            if (!confirm('Delete this entry?')) return;

            state.entries = state.entries.filter(e => e.id !== editingEntryId);
            saveState();
            closeModal();
            renderTodayEntries();
            loadHistoryDate();
        }

        function closeModal() {
            document.getElementById('entry-modal').classList.remove('active');
            editingEntryId = null;
        }

        // Finish Day
        function finishDay() {
            if (state.timerRunning) {
                stopTimer();
            }
            document.getElementById('finish-notes').value = state.dayNotes[new Date().toISOString().split('T')[0]] || '';
            document.getElementById('finish-modal').classList.add('active');
        }

        function saveFinishDay() {
            const today = new Date().toISOString().split('T')[0];
            const notes = document.getElementById('finish-notes').value.trim();
            if (notes) {
                state.dayNotes[today] = notes;
            }
            saveState();
            closeFinishModal();
        }

        function closeFinishModal() {
            document.getElementById('finish-modal').classList.remove('active');
        }

        // History
        function loadHistoryDate() {
            const date = document.getElementById('history-date').value;
            if (!date) return;

            renderEntries('history-entries', date);
            renderPhotos('history-photos', date);

            const entries = state.entries.filter(e => e.date === date);
            let totalMs = 0;
            entries.forEach(e => {
                totalMs += parseDuration(e.startTime, e.endTime);
            });
            const hours = (totalMs / 3600000).toFixed(2);
            document.getElementById('history-total').textContent = hours + ' hrs';

            document.getElementById('history-notes').value = state.dayNotes[date] || '';
        }

        function saveHistoryNotes() {
            const date = document.getElementById('history-date').value;
            const notes = document.getElementById('history-notes').value.trim();
            if (notes) {
                state.dayNotes[date] = notes;
            } else {
                delete state.dayNotes[date];
            }
            saveState();
            alert('Notes saved!');
        }

        // Photo Functions
        function renderTodayPhotos() {
            const today = new Date().toISOString().split('T')[0];
            renderPhotos('today-photos', today);
        }

        function renderPhotos(containerId, date) {
            const container = document.getElementById(containerId);
            const photos = state.photos.filter(p => p.date === date).sort((a, b) => b.timestamp - a.timestamp);

            if (photos.length === 0) {
                container.innerHTML = '<div class="no-photos">No photos for this day</div>';
                return;
            }

            container.innerHTML = `<div class="photo-grid">${photos.map(photo => `
                <div class="photo-thumbnail" onclick="viewPhoto('${photo.id}')">
                    <img src="${photo.data}" alt="Photo">
                    ${photo.note ? `<div class="photo-note-preview">${photo.note}</div>` : ''}
                </div>
            `).join('')}</div>`;
        }

        function openPhotoCapture(date = null) {
            pendingPhotoData = null;
            pendingPhotoDate = date || new Date().toISOString().split('T')[0];
            document.getElementById('photo-file-input').value = '';
            document.getElementById('photo-note').value = '';
            document.getElementById('photo-preview-container').innerHTML = '<span class="photo-preview-placeholder">No photo selected</span>';
            document.getElementById('photo-modal').classList.add('active');
        }

        function closePhotoModal() {
            document.getElementById('photo-modal').classList.remove('active');
            pendingPhotoData = null;
            pendingPhotoDate = null;
        }

        function handlePhotoSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                // Compress and resize the image
                compressImage(e.target.result, 800, 0.7, function(compressedData) {
                    pendingPhotoData = compressedData;
                    document.getElementById('photo-preview-container').innerHTML = `<img src="${compressedData}" alt="Preview">`;
                });
            };
            reader.readAsDataURL(file);
        }

        function compressImage(dataUrl, maxWidth, quality, callback) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;

                if (width > maxWidth) {
                    height = (height * maxWidth) / width;
                    width = maxWidth;
                }

                canvas.width = width;
                canvas.height = height;

                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                const compressedData = canvas.toDataURL('image/jpeg', quality);
                callback(compressedData);
            };
            img.src = dataUrl;
        }

        function savePhoto() {
            if (!pendingPhotoData) {
                alert('Please select a photo first');
                return;
            }

            const photo = {
                id: generateId(),
                date: pendingPhotoDate,
                timestamp: Date.now(),
                note: document.getElementById('photo-note').value.trim(),
                data: pendingPhotoData
            };

            state.photos.push(photo);
            saveState();
            closePhotoModal();
            renderTodayPhotos();
            loadHistoryDate();
        }

        function viewPhoto(id) {
            const photo = state.photos.find(p => p.id === id);
            if (!photo) return;

            viewingPhotoId = id;
            document.getElementById('photo-view-image').src = photo.data;
            document.getElementById('photo-view-note-text').textContent = photo.note || '(No note)';
            document.getElementById('photo-view-timestamp').textContent = new Date(photo.timestamp).toLocaleString();
            document.getElementById('photo-view-modal').classList.add('active');
        }

        function closePhotoViewModal() {
            document.getElementById('photo-view-modal').classList.remove('active');
            viewingPhotoId = null;
        }

        function deletePhoto() {
            if (!viewingPhotoId) return;
            if (!confirm('Delete this photo?')) return;

            state.photos = state.photos.filter(p => p.id !== viewingPhotoId);
            saveState();
            closePhotoViewModal();
            renderTodayPhotos();
            loadHistoryDate();
        }

        // PDF Report
        function generatePDF() {
            const startDate = document.getElementById('report-start').value;
            const endDate = document.getElementById('report-end').value;

            if (!startDate || !endDate) {
                alert('Please select start and end dates');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            let y = 20;

            // Title
            doc.setFontSize(18);
            doc.text('Andy & Sons Time Report', 105, y, { align: 'center' });
            y += 10;

            doc.setFontSize(12);
            doc.text(`${formatDateDisplay(startDate)} - ${formatDateDisplay(endDate)}`, 105, y, { align: 'center' });
            y += 15;

            // Get entries in date range
            const entries = state.entries.filter(e => e.date >= startDate && e.date <= endDate)
                .sort((a, b) => a.date.localeCompare(b.date) || a.startTime.localeCompare(b.startTime));

            // Group by date
            const byDate = {};
            entries.forEach(e => {
                if (!byDate[e.date]) byDate[e.date] = [];
                byDate[e.date].push(e);
            });

            // Calculate totals by type
            const byType = {};
            let grandTotal = 0;
            entries.forEach(e => {
                const ms = parseDuration(e.startTime, e.endTime);
                if (!byType[e.type]) byType[e.type] = 0;
                byType[e.type] += ms;
                grandTotal += ms;
            });

            // Summary
            doc.setFontSize(14);
            doc.text('Summary', 20, y);
            y += 8;

            doc.setFontSize(10);
            Object.keys(byType).sort().forEach(type => {
                const hours = (byType[type] / 3600000).toFixed(2);
                doc.text(`${type}: ${hours} hrs`, 25, y);
                y += 6;
            });

            doc.setFontSize(12);
            y += 4;
            doc.text(`Total: ${(grandTotal / 3600000).toFixed(2)} hours`, 20, y);
            y += 15;

            // Daily breakdown
            doc.setFontSize(14);
            doc.text('Daily Breakdown', 20, y);
            y += 10;

            doc.setFontSize(10);
            Object.keys(byDate).sort().forEach(date => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }

                let dayTotal = 0;
                byDate[date].forEach(e => {
                    dayTotal += parseDuration(e.startTime, e.endTime);
                });

                doc.setFontSize(11);
                doc.text(`${formatDateDisplay(date)} - ${(dayTotal / 3600000).toFixed(2)} hrs`, 20, y);
                y += 6;

                doc.setFontSize(9);
                byDate[date].forEach(e => {
                    const duration = calculateDuration(e.startTime, e.endTime);
                    doc.text(`  ${e.startTime} - ${e.endTime}  |  ${e.type}  |  ${duration}`, 25, y);
                    y += 5;
                });

                if (state.dayNotes[date]) {
                    doc.setFontSize(8);
                    doc.text(`  Notes: ${state.dayNotes[date]}`, 25, y);
                    y += 5;
                }

                y += 5;
            });

            doc.save(`timecard_${startDate}_to_${endDate}.pdf`);
        }

        // Utilities
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function formatTime(date) {
            return date.toTimeString().slice(0, 5);
        }

        function formatDuration(ms) {
            const seconds = Math.floor(ms / 1000);
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function calculateDuration(start, end) {
            const ms = parseDuration(start, end);
            const hours = Math.floor(ms / 3600000);
            const minutes = Math.floor((ms % 3600000) / 60000);
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            }
            return `${minutes}m`;
        }

        function parseDuration(start, end) {
            const [sh, sm] = start.split(':').map(Number);
            const [eh, em] = end.split(':').map(Number);
            return ((eh * 60 + em) - (sh * 60 + sm)) * 60000;
        }

        function formatDateDisplay(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // Backup/Export
        function exportData() {
            const data = JSON.stringify(state, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `timecard_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        // Start app
        init();
    </script>
</body>
</html>
