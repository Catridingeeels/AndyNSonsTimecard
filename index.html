<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Andy & Sons Timecard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #16a34a;
            --success-dark: #15803d;
            --danger: #dc2626;
            --danger-dark: #b91c1c;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-500: #6b7280;
            --gray-700: #374151;
            --gray-900: #111827;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gray-100);
            min-height: 100vh;
            color: var(--gray-900);
        }

        /* Header */
        .header {
            background: var(--primary);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .header-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .header-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            cursor: pointer;
        }

        .header-user {
            font-size: 0.75rem;
            opacity: 0.9;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Navigation */
        .nav {
            display: flex;
            background: white;
            border-bottom: 1px solid var(--gray-200);
        }

        .nav-btn {
            flex: 1;
            padding: 0.75rem;
            border: none;
            background: none;
            font-size: 0.875rem;
            color: var(--gray-500);
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .nav-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            font-weight: 600;
        }

        /* Views */
        .view {
            display: none;
            padding: 1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .view.active {
            display: block;
        }

        /* Login View */
        .login-view {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
            padding: 2rem;
        }

        .login-container {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-container h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--gray-900);
        }

        .login-container p {
            color: var(--gray-500);
            font-size: 0.875rem;
            margin-bottom: 1.5rem;
        }

        .login-input {
            width: 100%;
            padding: 0.875rem;
            border: 2px solid var(--gray-200);
            border-radius: 0.5rem;
            font-size: 1rem;
            margin-bottom: 1rem;
            transition: border-color 0.2s;
        }

        .login-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .login-btn {
            width: 100%;
            padding: 0.875rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .login-btn:hover {
            background: var(--primary-dark);
        }

        .login-btn:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
        }

        .login-message {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        .login-message.success {
            background: rgba(22, 163, 74, 0.1);
            color: var(--success);
        }

        .login-message.error {
            background: rgba(220, 38, 38, 0.1);
            color: var(--danger);
        }

        .login-logo {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Sync Status */
        .sync-status {
            font-size: 0.625rem;
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            background: rgba(255,255,255,0.2);
        }

        .sync-status.syncing {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Timer View */
        .timer-display {
            text-align: center;
            padding: 2rem 0;
        }

        .current-date {
            color: var(--gray-500);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .timer-time {
            font-size: 3.5rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            margin-bottom: 0.5rem;
        }

        .timer-status {
            font-size: 1rem;
            color: var(--gray-500);
            margin-bottom: 1rem;
        }

        .timer-status.running {
            color: var(--success);
            font-weight: 600;
        }

        .timer-btn {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            border: none;
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
            cursor: pointer;
            margin: 1rem auto;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 14px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }

        .timer-btn:active {
            transform: scale(0.95);
        }

        .timer-btn.start {
            background: var(--success);
        }

        .timer-btn.stop {
            background: var(--danger);
        }

        /* Work Type Selector */
        .type-selector {
            margin: 1.5rem 0;
        }

        .type-selector label {
            display: block;
            font-size: 0.875rem;
            color: var(--gray-500);
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .type-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .type-btn {
            padding: 0.75rem 0.5rem;
            border: 2px solid var(--gray-200);
            background: white;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .type-btn.selected {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary);
            font-weight: 600;
        }

        /* Today's Entries */
        .section-title {
            font-size: 1rem;
            font-weight: 600;
            margin: 1.5rem 0 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .add-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.4rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .entry-list {
            background: white;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .entry-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--gray-100);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .entry-item:last-child {
            border-bottom: none;
        }

        .entry-info {
            flex: 1;
        }

        .entry-type {
            font-weight: 500;
            font-size: 0.875rem;
        }

        .entry-time {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .entry-duration {
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--primary);
            margin-right: 0.75rem;
        }

        .entry-actions {
            display: flex;
            gap: 0.25rem;
        }

        .entry-actions button {
            background: none;
            border: none;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .entry-actions button:hover {
            color: var(--gray-900);
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--gray-500);
        }

        /* Finish Day Button */
        .finish-day-btn {
            width: 100%;
            padding: 1rem;
            background: var(--gray-700);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1.5rem;
        }

        /* History View */
        .date-picker {
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .date-picker input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.375rem;
            font-size: 1rem;
        }

        .day-summary {
            background: white;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .day-summary h3 {
            font-size: 0.875rem;
            color: var(--gray-500);
            margin-bottom: 0.5rem;
        }

        .day-total {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .day-notes {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
        }

        .day-notes textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.375rem;
            font-size: 0.875rem;
            resize: vertical;
            min-height: 80px;
        }

        .save-notes-btn {
            margin-top: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            cursor: pointer;
        }

        /* Reports View */
        .report-form {
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.375rem;
            font-size: 1rem;
        }

        .generate-btn {
            width: 100%;
            padding: 1rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 0.75rem;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.125rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-500);
        }

        .modal-body {
            padding: 1rem;
        }

        .modal-footer {
            padding: 1rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            gap: 0.5rem;
        }

        .modal-footer button {
            flex: 1;
            padding: 0.75rem;
            border-radius: 0.375rem;
            font-size: 1rem;
            cursor: pointer;
        }

        .btn-cancel {
            background: var(--gray-200);
            border: none;
            color: var(--gray-700);
        }

        .btn-save {
            background: var(--primary);
            border: none;
            color: white;
        }

        .btn-delete {
            background: var(--danger);
            border: none;
            color: white;
        }

        /* Photo Feature Styles */
        .section-title-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .camera-btn {
            background: var(--gray-700);
            color: white;
            border: none;
            padding: 0.4rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .photo-thumbnail {
            aspect-ratio: 1;
            border-radius: 0.375rem;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            background: var(--gray-200);
        }

        .photo-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-thumbnail .photo-note-preview {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            font-size: 0.625rem;
            padding: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .photo-section {
            margin-top: 1rem;
        }

        .photo-section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        .no-photos {
            text-align: center;
            padding: 1rem;
            color: var(--gray-500);
            font-size: 0.875rem;
            background: white;
            border-radius: 0.5rem;
        }

        /* Photo Capture Modal */
        .photo-preview-container {
            width: 100%;
            aspect-ratio: 4/3;
            background: var(--gray-100);
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .photo-preview-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .photo-preview-placeholder {
            color: var(--gray-500);
            font-size: 0.875rem;
        }

        .photo-input-label {
            display: block;
            width: 100%;
            padding: 0.75rem;
            background: var(--primary);
            color: white;
            text-align: center;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .photo-input-label:hover {
            background: var(--primary-dark);
        }

        #photo-file-input {
            display: none;
        }

        /* Photo View Modal */
        .photo-view-container {
            width: 100%;
            max-height: 60vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gray-900);
            border-radius: 0.375rem;
            overflow: hidden;
        }

        .photo-view-container img {
            max-width: 100%;
            max-height: 60vh;
            object-fit: contain;
        }

        .photo-view-note {
            margin-top: 1rem;
            padding: 0.75rem;
            background: var(--gray-100);
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }

        .photo-view-note label {
            display: block;
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-bottom: 0.25rem;
        }

        .photo-view-timestamp {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: 0.5rem;
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 300;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Migration banner */
        .migration-banner {
            background: rgba(37, 99, 235, 0.1);
            border: 1px solid var(--primary);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .migration-banner p {
            font-size: 0.875rem;
            color: var(--gray-700);
            margin-bottom: 0.75rem;
        }

        .migration-banner button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            cursor: pointer;
            margin: 0 0.25rem;
        }

        .migration-banner button.secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        /* Config notice */
        .config-notice {
            background: rgba(220, 38, 38, 0.1);
            border: 1px solid var(--danger);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: var(--danger-dark);
        }

        .config-notice code {
            background: rgba(0,0,0,0.1);
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Login View (shown when not authenticated) -->
    <div id="login-view" class="login-view" style="display: none;">
        <div class="login-container">
            <div class="login-logo">&#128337;</div>
            <h2>Andy & Sons</h2>
            <p>Enter your email to receive a login link</p>
            <div id="config-notice" class="config-notice" style="display: none;">
                Supabase not configured. Please set <code>SUPABASE_URL</code> and <code>SUPABASE_KEY</code> in the code.
            </div>
            <input type="email" class="login-input" id="login-email" placeholder="your@email.com">
            <button class="login-btn" id="login-btn" onclick="sendMagicLink()">Send Login Link</button>
            <div id="login-message" class="login-message" style="display: none;"></div>
        </div>
    </div>

    <!-- Main App (shown when authenticated) -->
    <div id="app-container" style="display: none;">
        <header class="header">
            <h1>Andy & Sons</h1>
            <div class="header-buttons">
                <span class="sync-status" id="sync-status">Synced</span>
                <span class="header-user" id="header-user"></span>
                <button class="header-btn" onclick="logout()">Logout</button>
            </div>
        </header>

        <nav class="nav">
            <button class="nav-btn active" data-view="timer">Timer</button>
            <button class="nav-btn" data-view="history">History</button>
            <button class="nav-btn" data-view="reports">Reports</button>
        </nav>

        <!-- Migration Banner -->
        <div id="migration-banner" class="migration-banner" style="display: none;">
            <p>Found local data from before cloud sync. Would you like to upload it?</p>
            <button onclick="migrateLocalData()">Upload Local Data</button>
            <button class="secondary" onclick="dismissMigration()">Skip</button>
        </div>

        <!-- Timer View -->
        <div id="timer-view" class="view active">
            <div class="timer-display">
                <div class="current-date" id="current-date"></div>
                <div class="timer-time" id="timer-time">00:00:00</div>
                <div class="timer-status" id="timer-status">Ready to start</div>
                <button class="timer-btn start" id="timer-btn" onclick="toggleTimer()">START</button>
            </div>

            <div class="type-selector">
                <label>Work Type</label>
                <div class="type-grid" id="type-grid"></div>
            </div>

            <div class="section-title">
                <span>Today's Entries</span>
                <div class="section-title-buttons">
                    <button class="camera-btn" onclick="openPhotoCapture()">Photo</button>
                    <button class="add-btn" onclick="openAddEntry()">+ Add</button>
                </div>
            </div>
            <div class="entry-list" id="today-entries"></div>

            <div class="photo-section">
                <div class="photo-section-title">Today's Photos</div>
                <div id="today-photos"></div>
            </div>

            <button class="finish-day-btn" onclick="finishDay()">Finish Day</button>
        </div>

        <!-- History View -->
        <div id="history-view" class="view">
            <div class="date-picker">
                <input type="date" id="history-date" onchange="loadHistoryDate()">
            </div>
            <div class="day-summary">
                <h3>Total Hours</h3>
                <div class="day-total" id="history-total">0.00 hrs</div>
                <div class="day-notes">
                    <label style="font-size: 0.875rem; color: var(--gray-500);">Day Notes</label>
                    <textarea id="history-notes" placeholder="Notes for this day..."></textarea>
                    <button class="save-notes-btn" onclick="saveHistoryNotes()">Save Notes</button>
                </div>
            </div>
            <div class="section-title">
                <span>Entries</span>
                <div class="section-title-buttons">
                    <button class="camera-btn" onclick="openPhotoCapture(document.getElementById('history-date').value)">Photo</button>
                    <button class="add-btn" onclick="openAddEntry(document.getElementById('history-date').value)">+ Add</button>
                </div>
            </div>
            <div class="entry-list" id="history-entries"></div>

            <div class="photo-section">
                <div class="photo-section-title">Photos</div>
                <div id="history-photos"></div>
            </div>
        </div>

        <!-- Reports View -->
        <div id="reports-view" class="view">
            <div class="report-form">
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" id="report-start">
                </div>
                <div class="form-group">
                    <label>End Date</label>
                    <input type="date" id="report-end">
                </div>
                <button class="generate-btn" onclick="generatePDF()">Generate PDF Report</button>
            </div>
        </div>
    </div>

    <!-- Entry Modal -->
    <div class="modal-overlay" id="entry-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modal-title">Add Entry</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="entry-date">
                </div>
                <div class="form-group">
                    <label>Start Time</label>
                    <input type="time" id="entry-start">
                </div>
                <div class="form-group">
                    <label>End Time</label>
                    <input type="time" id="entry-end">
                </div>
                <div class="form-group">
                    <label>Work Type</label>
                    <select id="entry-type"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal()">Cancel</button>
                <button class="btn-delete" id="delete-btn" onclick="deleteEntry()" style="display:none;">Delete</button>
                <button class="btn-save" onclick="saveEntry()">Save</button>
            </div>
        </div>
    </div>

    <!-- Photo Capture Modal -->
    <div class="modal-overlay" id="photo-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>Add Photo</h2>
                <button class="modal-close" onclick="closePhotoModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="photo-preview-container" id="photo-preview-container">
                    <span class="photo-preview-placeholder">No photo selected</span>
                </div>
                <label class="photo-input-label">
                    Take Photo or Choose File
                    <input type="file" id="photo-file-input" accept="image/*" capture="environment" onchange="handlePhotoSelect(event)">
                </label>
                <div class="form-group">
                    <label>Note / Caption</label>
                    <input type="text" id="photo-note" placeholder="e.g., 123 Main St - before painting">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closePhotoModal()">Cancel</button>
                <button class="btn-save" onclick="savePhoto()">Save Photo</button>
            </div>
        </div>
    </div>

    <!-- Photo View Modal -->
    <div class="modal-overlay" id="photo-view-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>Photo</h2>
                <button class="modal-close" onclick="closePhotoViewModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="photo-view-container">
                    <img id="photo-view-image" src="" alt="Photo">
                </div>
                <div class="photo-view-note" id="photo-view-note-container">
                    <label>Note</label>
                    <div id="photo-view-note-text"></div>
                </div>
                <div class="photo-view-timestamp" id="photo-view-timestamp"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closePhotoViewModal()">Close</button>
                <button class="btn-delete" onclick="deletePhoto()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Finish Day Modal -->
    <div class="modal-overlay" id="finish-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>Finish Day</h2>
                <button class="modal-close" onclick="closeFinishModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem; color: var(--gray-500);">Add any notes about today's work:</p>
                <textarea id="finish-notes" style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 0.375rem; min-height: 100px;"></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeFinishModal()">Cancel</button>
                <button class="btn-save" onclick="saveFinishDay()">Save & Finish</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // SUPABASE CONFIGURATION
        // ============================================
        // Replace these with your Supabase project credentials
        // Get them from: Supabase Dashboard > Settings > API
        const SUPABASE_URL = 'https://nksxepnfhinyzemaqljf.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_p3Ih3hEHjnO_9zfk0DLHiA__6IP0dhv';

        // Initialize Supabase client (if configured)
        let supabaseClient = null;
        let isSupabaseConfigured = false;

        try {
            if (SUPABASE_URL !== 'YOUR_PROJECT_URL' && SUPABASE_KEY !== 'YOUR_ANON_KEY') {
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                isSupabaseConfigured = true;
            }
        } catch (e) {
            console.error('Failed to initialize Supabase:', e);
        }

        // ============================================
        // WORK TYPES
        // ============================================
        const WORK_TYPES = [
            'Landscape',
            'Floor and Counter',
            'Painting Exterior',
            'Interior Finish Carpentry',
            'Building Repair/Remodel',
            'Painting Interior',
            'Contractor Shop/cleaning',
            'Residential Cleaning'
        ];

        // ============================================
        // STATE
        // ============================================
        let state = {
            entries: [],
            dayNotes: {},
            photos: [],
            timerRunning: false,
            timerStart: null,
            selectedType: WORK_TYPES[0]
        };

        let currentUser = null;
        let timerInterval = null;
        let editingEntryId = null;
        let pendingPhotoData = null;
        let pendingPhotoFile = null;
        let pendingPhotoDate = null;
        let viewingPhotoId = null;
        let photoUrlCache = {};

        // ============================================
        // INITIALIZATION
        // ============================================
        async function init() {
            if (!isSupabaseConfigured) {
                hideLoading();
                document.getElementById('config-notice').style.display = 'block';
                document.getElementById('login-view').style.display = 'flex';
                document.getElementById('login-btn').disabled = true;
                return;
            }

            // Check for existing session
            const { data: { session } } = await supabaseClient.auth.getSession();

            if (session) {
                currentUser = session.user;
                await showApp();
            } else {
                hideLoading();
                document.getElementById('login-view').style.display = 'flex';
            }

            // Listen for auth changes (e.g., magic link callback)
            supabaseClient.auth.onAuthStateChange(async (event, session) => {
                if (event === 'SIGNED_IN' && session) {
                    currentUser = session.user;
                    await showApp();
                } else if (event === 'SIGNED_OUT') {
                    currentUser = null;
                    document.getElementById('app-container').style.display = 'none';
                    document.getElementById('login-view').style.display = 'flex';
                }
            });
        }

        async function showApp() {
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            document.getElementById('header-user').textContent = currentUser.email.split('@')[0];

            await loadStateFromSupabase();

            renderTypeGrid();
            renderTypeSelect();
            updateDate();
            renderTodayEntries();
            await renderTodayPhotos();
            setupNav();

            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('history-date').value = today;
            document.getElementById('report-start').value = today;
            document.getElementById('report-end').value = today;

            // Resume timer if was running (stored locally for this session)
            loadTimerState();
            if (state.timerRunning && state.timerStart) {
                startTimerDisplay();
            }

            // Check for migration
            checkForMigration();

            // Update date every minute
            setInterval(updateDate, 60000);

            hideLoading();

            // Set up real-time subscriptions
            setupRealtimeSubscriptions();
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        // ============================================
        // AUTHENTICATION
        // ============================================
        async function sendMagicLink() {
            const email = document.getElementById('login-email').value.trim();
            if (!email) {
                showLoginMessage('Please enter your email', 'error');
                return;
            }

            const btn = document.getElementById('login-btn');
            btn.disabled = true;
            btn.textContent = 'Sending...';

            try {
                const { error } = await supabaseClient.auth.signInWithOtp({
                    email: email,
                    options: {
                        emailRedirectTo: window.location.origin + window.location.pathname
                    }
                });

                if (error) throw error;

                showLoginMessage('Check your email for the login link!', 'success');
            } catch (error) {
                showLoginMessage(error.message || 'Failed to send login link', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Send Login Link';
            }
        }

        function showLoginMessage(message, type) {
            const el = document.getElementById('login-message');
            el.textContent = message;
            el.className = 'login-message ' + type;
            el.style.display = 'block';
        }

        async function logout() {
            if (!confirm('Are you sure you want to logout?')) return;

            // Clear timer state
            localStorage.removeItem('andySonsTimerState');
            state.timerRunning = false;
            state.timerStart = null;
            clearInterval(timerInterval);

            await supabaseClient.auth.signOut();
        }

        // ============================================
        // DATA LOADING FROM SUPABASE
        // ============================================
        async function loadStateFromSupabase() {
            setSyncStatus('syncing', 'Loading...');

            try {
                // Load entries
                const { data: entries, error: entriesError } = await supabaseClient
                    .from('entries')
                    .select('*')
                    .order('date', { ascending: false })
                    .order('start_time', { ascending: true });

                if (entriesError) throw entriesError;

                state.entries = (entries || []).map(e => ({
                    id: e.id,
                    date: e.date,
                    startTime: e.start_time.slice(0, 5),
                    endTime: e.end_time.slice(0, 5),
                    type: e.work_type,
                    userId: e.user_id
                }));

                // Load day notes
                const { data: dayNotes, error: notesError } = await supabaseClient
                    .from('day_notes')
                    .select('*');

                if (notesError) throw notesError;

                state.dayNotes = {};
                (dayNotes || []).forEach(n => {
                    state.dayNotes[n.date] = n.notes;
                });

                // Load photos metadata
                const { data: photos, error: photosError } = await supabaseClient
                    .from('photos')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (photosError) throw photosError;

                state.photos = (photos || []).map(p => ({
                    id: p.id,
                    date: p.date,
                    note: p.note,
                    storagePath: p.storage_path,
                    timestamp: new Date(p.created_at).getTime(),
                    userId: p.user_id
                }));

                setSyncStatus('synced', 'Synced');
            } catch (error) {
                console.error('Error loading state:', error);
                setSyncStatus('error', 'Sync Error');
            }
        }

        function setSyncStatus(status, text) {
            const el = document.getElementById('sync-status');
            el.textContent = text;
            el.className = 'sync-status ' + (status === 'syncing' ? 'syncing' : '');
        }

        // ============================================
        // TIMER STATE (Local - persists across page refresh)
        // ============================================
        function loadTimerState() {
            const saved = localStorage.getItem('andySonsTimerState');
            if (saved) {
                const parsed = JSON.parse(saved);
                state.timerRunning = parsed.timerRunning || false;
                state.timerStart = parsed.timerStart || null;
                state.selectedType = parsed.selectedType || WORK_TYPES[0];
            }
        }

        function saveTimerState() {
            localStorage.setItem('andySonsTimerState', JSON.stringify({
                timerRunning: state.timerRunning,
                timerStart: state.timerStart,
                selectedType: state.selectedType
            }));
        }

        // ============================================
        // REAL-TIME SUBSCRIPTIONS
        // ============================================
        function setupRealtimeSubscriptions() {
            // Subscribe to entries changes
            supabaseClient
                .channel('entries-changes')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'entries' },
                    () => {
                        loadStateFromSupabase().then(() => {
                            renderTodayEntries();
                            loadHistoryDate();
                        });
                    }
                )
                .subscribe();

            // Subscribe to photos changes
            supabaseClient
                .channel('photos-changes')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'photos' },
                    () => {
                        loadStateFromSupabase().then(async () => {
                            await renderTodayPhotos();
                            await loadHistoryDate();
                        });
                    }
                )
                .subscribe();

            // Subscribe to day_notes changes
            supabaseClient
                .channel('notes-changes')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'day_notes' },
                    () => {
                        loadStateFromSupabase().then(() => {
                            loadHistoryDate();
                        });
                    }
                )
                .subscribe();
        }

        // ============================================
        // NAVIGATION
        // ============================================
        function setupNav() {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById(btn.dataset.view + '-view').classList.add('active');

                    if (btn.dataset.view === 'history') {
                        await loadHistoryDate();
                    }
                    if (btn.dataset.view === 'timer') {
                        await renderTodayPhotos();
                    }
                });
            });
        }

        // Swipe navigation
        let touchStartX = 0;
        let touchEndX = 0;
        const SWIPE_THRESHOLD = 50;
        const views = ['timer', 'history', 'reports'];

        document.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        }, { passive: true });

        document.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, { passive: true });

        function handleSwipe() {
            const diff = touchStartX - touchEndX;
            if (Math.abs(diff) < SWIPE_THRESHOLD) return;

            // Find current view
            const currentBtn = document.querySelector('.nav-btn.active');
            const currentView = currentBtn.dataset.view;
            const currentIndex = views.indexOf(currentView);

            let newIndex;
            if (diff > 0) {
                // Swipe left = next view
                newIndex = Math.min(currentIndex + 1, views.length - 1);
            } else {
                // Swipe right = previous view
                newIndex = Math.max(currentIndex - 1, 0);
            }

            if (newIndex !== currentIndex) {
                document.querySelector(`[data-view="${views[newIndex]}"]`).click();
            }
        }

        // ============================================
        // DATE DISPLAY
        // ============================================
        function updateDate() {
            const now = new Date();
            const options = { weekday: 'long', month: 'long', day: 'numeric' };
            document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', options);
        }

        // ============================================
        // WORK TYPE SELECTOR
        // ============================================
        function renderTypeGrid() {
            const grid = document.getElementById('type-grid');
            grid.innerHTML = WORK_TYPES.map(type => `
                <button class="type-btn ${state.selectedType === type ? 'selected' : ''}"
                        onclick="selectType('${type}')">${type}</button>
            `).join('');
        }

        async function selectType(type) {
            // If timer is running, save current segment and start new one
            if (state.timerRunning) {
                await saveCurrentSegment();
                state.timerStart = Date.now();
            }
            state.selectedType = type;
            saveTimerState();
            renderTypeGrid();
            renderTodayEntries();
        }

        function renderTypeSelect() {
            const select = document.getElementById('entry-type');
            select.innerHTML = WORK_TYPES.map(type =>
                `<option value="${type}">${type}</option>`
            ).join('');
        }

        // ============================================
        // TIMER
        // ============================================
        function toggleTimer() {
            if (state.timerRunning) {
                stopTimer();
            } else {
                startTimer();
            }
        }

        function startTimer() {
            state.timerRunning = true;
            state.timerStart = Date.now();
            saveTimerState();
            startTimerDisplay();

            const btn = document.getElementById('timer-btn');
            btn.textContent = 'STOP';
            btn.classList.remove('start');
            btn.classList.add('stop');

            document.getElementById('timer-status').textContent = state.selectedType;
            document.getElementById('timer-status').classList.add('running');
        }

        async function stopTimer() {
            await saveCurrentSegment();

            state.timerRunning = false;
            state.timerStart = null;
            saveTimerState();

            clearInterval(timerInterval);
            document.getElementById('timer-time').textContent = '00:00:00';

            const btn = document.getElementById('timer-btn');
            btn.textContent = 'START';
            btn.classList.remove('stop');
            btn.classList.add('start');

            document.getElementById('timer-status').textContent = 'Ready to start';
            document.getElementById('timer-status').classList.remove('running');

            renderTodayEntries();
        }

        async function saveCurrentSegment() {
            if (!state.timerStart) return;

            const startDate = new Date(state.timerStart);
            const endDate = new Date();

            setSyncStatus('syncing', 'Saving...');

            try {
                const { error } = await supabaseClient
                    .from('entries')
                    .insert({
                        user_id: currentUser.id,
                        date: startDate.toISOString().split('T')[0],
                        start_time: formatTime(startDate),
                        end_time: formatTime(endDate),
                        work_type: state.selectedType
                    });

                if (error) throw error;

                // Reload entries
                await loadStateFromSupabase();
                setSyncStatus('synced', 'Synced');
            } catch (error) {
                console.error('Error saving segment:', error);
                setSyncStatus('error', 'Error');
            }
        }

        function startTimerDisplay() {
            updateTimerDisplay();
            timerInterval = setInterval(updateTimerDisplay, 1000);

            const btn = document.getElementById('timer-btn');
            btn.textContent = 'STOP';
            btn.classList.remove('start');
            btn.classList.add('stop');

            document.getElementById('timer-status').textContent = state.selectedType;
            document.getElementById('timer-status').classList.add('running');
        }

        function updateTimerDisplay() {
            if (!state.timerStart) return;
            const elapsed = Date.now() - state.timerStart;
            document.getElementById('timer-time').textContent = formatDuration(elapsed);
        }

        // ============================================
        // ENTRY MANAGEMENT
        // ============================================
        function renderTodayEntries() {
            const today = new Date().toISOString().split('T')[0];
            renderEntries('today-entries', today);
        }

        function renderEntries(containerId, date) {
            const container = document.getElementById(containerId);
            const entries = state.entries.filter(e => e.date === date).sort((a, b) =>
                a.startTime.localeCompare(b.startTime)
            );

            if (entries.length === 0) {
                container.innerHTML = '<div class="empty-state">No entries yet</div>';
                return;
            }

            container.innerHTML = entries.map(entry => `
                <div class="entry-item">
                    <div class="entry-info">
                        <div class="entry-type">${entry.type}</div>
                        <div class="entry-time">${entry.startTime} - ${entry.endTime}</div>
                    </div>
                    <div class="entry-duration">${calculateDuration(entry.startTime, entry.endTime)}</div>
                    <div class="entry-actions">
                        <button onclick="editEntry('${entry.id}')">Edit</button>
                    </div>
                </div>
            `).join('');
        }

        function openAddEntry(date = null) {
            editingEntryId = null;
            document.getElementById('modal-title').textContent = 'Add Entry';
            document.getElementById('delete-btn').style.display = 'none';

            const today = date || new Date().toISOString().split('T')[0];
            document.getElementById('entry-date').value = today;
            document.getElementById('entry-start').value = '';
            document.getElementById('entry-end').value = '';
            document.getElementById('entry-type').value = state.selectedType;

            document.getElementById('entry-modal').classList.add('active');
        }

        function editEntry(id) {
            const entry = state.entries.find(e => e.id === id);
            if (!entry) return;

            editingEntryId = id;
            document.getElementById('modal-title').textContent = 'Edit Entry';
            document.getElementById('delete-btn').style.display = 'block';

            document.getElementById('entry-date').value = entry.date;
            document.getElementById('entry-start').value = entry.startTime;
            document.getElementById('entry-end').value = entry.endTime;
            document.getElementById('entry-type').value = entry.type;

            document.getElementById('entry-modal').classList.add('active');
        }

        async function saveEntry() {
            const date = document.getElementById('entry-date').value;
            const startTime = document.getElementById('entry-start').value;
            const endTime = document.getElementById('entry-end').value;
            const type = document.getElementById('entry-type').value;

            if (!date || !startTime || !endTime) {
                alert('Please fill in all fields');
                return;
            }

            setSyncStatus('syncing', 'Saving...');

            try {
                if (editingEntryId) {
                    const { error } = await supabaseClient
                        .from('entries')
                        .update({
                            date: date,
                            start_time: startTime,
                            end_time: endTime,
                            work_type: type
                        })
                        .eq('id', editingEntryId);

                    if (error) throw error;
                } else {
                    const { error } = await supabaseClient
                        .from('entries')
                        .insert({
                            user_id: currentUser.id,
                            date: date,
                            start_time: startTime,
                            end_time: endTime,
                            work_type: type
                        });

                    if (error) throw error;
                }

                await loadStateFromSupabase();
                closeModal();
                renderTodayEntries();
                loadHistoryDate();
                setSyncStatus('synced', 'Synced');
            } catch (error) {
                console.error('Error saving entry:', error);
                setSyncStatus('error', 'Error');
                alert('Failed to save entry: ' + error.message);
            }
        }

        async function deleteEntry() {
            if (!editingEntryId) return;
            if (!confirm('Delete this entry?')) return;

            setSyncStatus('syncing', 'Deleting...');

            try {
                const { error } = await supabaseClient
                    .from('entries')
                    .delete()
                    .eq('id', editingEntryId);

                if (error) throw error;

                await loadStateFromSupabase();
                closeModal();
                renderTodayEntries();
                loadHistoryDate();
                setSyncStatus('synced', 'Synced');
            } catch (error) {
                console.error('Error deleting entry:', error);
                setSyncStatus('error', 'Error');
            }
        }

        function closeModal() {
            document.getElementById('entry-modal').classList.remove('active');
            editingEntryId = null;
        }

        // ============================================
        // FINISH DAY
        // ============================================
        function finishDay() {
            if (state.timerRunning) {
                stopTimer();
            }
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('finish-notes').value = state.dayNotes[today] || '';
            document.getElementById('finish-modal').classList.add('active');
        }

        async function saveFinishDay() {
            const today = new Date().toISOString().split('T')[0];
            const notes = document.getElementById('finish-notes').value.trim();

            if (notes) {
                await saveDayNotes(today, notes);
            }
            closeFinishModal();
        }

        function closeFinishModal() {
            document.getElementById('finish-modal').classList.remove('active');
        }

        // ============================================
        // HISTORY
        // ============================================
        async function loadHistoryDate() {
            const date = document.getElementById('history-date').value;
            if (!date) return;

            renderEntries('history-entries', date);
            await renderPhotos('history-photos', date);

            const entries = state.entries.filter(e => e.date === date);
            let totalMs = 0;
            entries.forEach(e => {
                totalMs += parseDuration(e.startTime, e.endTime);
            });
            const hours = (totalMs / 3600000).toFixed(2);
            document.getElementById('history-total').textContent = hours + ' hrs';

            document.getElementById('history-notes').value = state.dayNotes[date] || '';
        }

        async function saveHistoryNotes() {
            const date = document.getElementById('history-date').value;
            const notes = document.getElementById('history-notes').value.trim();
            await saveDayNotes(date, notes);
            alert('Notes saved!');
        }

        async function saveDayNotes(date, notes) {
            setSyncStatus('syncing', 'Saving...');

            try {
                if (notes) {
                    const { error } = await supabaseClient
                        .from('day_notes')
                        .upsert({
                            date: date,
                            notes: notes,
                            updated_at: new Date().toISOString()
                        }, { onConflict: 'date' });

                    if (error) throw error;
                    state.dayNotes[date] = notes;
                } else {
                    const { error } = await supabaseClient
                        .from('day_notes')
                        .delete()
                        .eq('date', date);

                    if (error) throw error;
                    delete state.dayNotes[date];
                }

                setSyncStatus('synced', 'Synced');
            } catch (error) {
                console.error('Error saving notes:', error);
                setSyncStatus('error', 'Error');
            }
        }

        // ============================================
        // PHOTO FUNCTIONS
        // ============================================
        async function renderTodayPhotos() {
            const today = new Date().toISOString().split('T')[0];
            await renderPhotos('today-photos', today);
        }

        async function renderPhotos(containerId, date) {
            const container = document.getElementById(containerId);
            const photos = state.photos.filter(p => p.date === date).sort((a, b) => b.timestamp - a.timestamp);

            if (photos.length === 0) {
                container.innerHTML = '<div class="no-photos">No photos for this day</div>';
                return;
            }

            // Get signed URLs for photos
            const photoHtml = await Promise.all(photos.map(async photo => {
                const url = await getPhotoUrl(photo.storagePath);
                return `
                    <div class="photo-thumbnail" onclick="viewPhoto('${photo.id}')">
                        <img src="${url}" alt="Photo" loading="lazy">
                        ${photo.note ? `<div class="photo-note-preview">${photo.note}</div>` : ''}
                    </div>
                `;
            }));

            container.innerHTML = `<div class="photo-grid">${photoHtml.join('')}</div>`;
        }

        async function getPhotoUrl(storagePath) {
            // Check cache first
            if (photoUrlCache[storagePath]) {
                return photoUrlCache[storagePath];
            }

            try {
                const { data, error } = await supabaseClient
                    .storage
                    .from('photos')
                    .createSignedUrl(storagePath, 3600); // 1 hour expiry

                if (error) throw error;

                photoUrlCache[storagePath] = data.signedUrl;
                return data.signedUrl;
            } catch (error) {
                console.error('Error getting photo URL:', error);
                return '';
            }
        }

        function openPhotoCapture(date = null) {
            pendingPhotoData = null;
            pendingPhotoFile = null;
            pendingPhotoDate = date || new Date().toISOString().split('T')[0];
            document.getElementById('photo-file-input').value = '';
            document.getElementById('photo-note').value = '';
            document.getElementById('photo-preview-container').innerHTML = '<span class="photo-preview-placeholder">No photo selected</span>';
            document.getElementById('photo-modal').classList.add('active');
        }

        function closePhotoModal() {
            document.getElementById('photo-modal').classList.remove('active');
            pendingPhotoData = null;
            pendingPhotoFile = null;
            pendingPhotoDate = null;
        }

        function handlePhotoSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            pendingPhotoFile = file;

            const reader = new FileReader();
            reader.onload = function(e) {
                // Compress and resize for preview
                compressImage(e.target.result, 800, 0.7, function(compressedData) {
                    pendingPhotoData = compressedData;
                    document.getElementById('photo-preview-container').innerHTML = `<img src="${compressedData}" alt="Preview">`;
                });
            };
            reader.readAsDataURL(file);
        }

        function compressImage(dataUrl, maxWidth, quality, callback) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;

                if (width > maxWidth) {
                    height = (height * maxWidth) / width;
                    width = maxWidth;
                }

                canvas.width = width;
                canvas.height = height;

                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                const compressedData = canvas.toDataURL('image/jpeg', quality);
                callback(compressedData);
            };
            img.src = dataUrl;
        }

        async function savePhoto() {
            if (!pendingPhotoFile) {
                alert('Please select a photo first');
                return;
            }

            setSyncStatus('syncing', 'Uploading...');

            try {
                // Generate unique filename
                const fileExt = pendingPhotoFile.name.split('.').pop() || 'jpg';
                const fileName = `${currentUser.id}/${pendingPhotoDate}/${Date.now()}.${fileExt}`;

                // Compress image before upload
                const compressedBlob = await compressImageForUpload(pendingPhotoData);

                // Upload to Supabase Storage
                const { error: uploadError } = await supabaseClient
                    .storage
                    .from('photos')
                    .upload(fileName, compressedBlob, {
                        contentType: 'image/jpeg'
                    });

                if (uploadError) throw uploadError;

                // Save metadata to database
                const { error: dbError } = await supabaseClient
                    .from('photos')
                    .insert({
                        user_id: currentUser.id,
                        date: pendingPhotoDate,
                        note: document.getElementById('photo-note').value.trim(),
                        storage_path: fileName
                    });

                if (dbError) throw dbError;

                await loadStateFromSupabase();
                closePhotoModal();
                await renderTodayPhotos();
                await loadHistoryDate();
                setSyncStatus('synced', 'Synced');
            } catch (error) {
                console.error('Error saving photo:', error);
                setSyncStatus('error', 'Error');
                alert('Failed to upload photo: ' + error.message);
            }
        }

        async function compressImageForUpload(dataUrl) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const maxWidth = 1200;
                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }

                    canvas.width = width;
                    canvas.height = height;

                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    canvas.toBlob(resolve, 'image/jpeg', 0.8);
                };
                img.src = dataUrl;
            });
        }

        async function viewPhoto(id) {
            const photo = state.photos.find(p => p.id === id);
            if (!photo) return;

            viewingPhotoId = id;

            const url = await getPhotoUrl(photo.storagePath);
            document.getElementById('photo-view-image').src = url;
            document.getElementById('photo-view-note-text').textContent = photo.note || '(No note)';
            document.getElementById('photo-view-timestamp').textContent = new Date(photo.timestamp).toLocaleString();
            document.getElementById('photo-view-modal').classList.add('active');
        }

        function closePhotoViewModal() {
            document.getElementById('photo-view-modal').classList.remove('active');
            viewingPhotoId = null;
        }

        async function deletePhoto() {
            if (!viewingPhotoId) return;
            if (!confirm('Delete this photo?')) return;

            const photo = state.photos.find(p => p.id === viewingPhotoId);
            if (!photo) return;

            setSyncStatus('syncing', 'Deleting...');

            try {
                // Delete from storage
                const { error: storageError } = await supabaseClient
                    .storage
                    .from('photos')
                    .remove([photo.storagePath]);

                if (storageError) throw storageError;

                // Delete from database
                const { error: dbError } = await supabaseClient
                    .from('photos')
                    .delete()
                    .eq('id', viewingPhotoId);

                if (dbError) throw dbError;

                // Remove from cache
                delete photoUrlCache[photo.storagePath];

                await loadStateFromSupabase();
                closePhotoViewModal();
                await renderTodayPhotos();
                await loadHistoryDate();
                setSyncStatus('synced', 'Synced');
            } catch (error) {
                console.error('Error deleting photo:', error);
                setSyncStatus('error', 'Error');
            }
        }

        // ============================================
        // PDF REPORT
        // ============================================
        function generatePDF() {
            const startDate = document.getElementById('report-start').value;
            const endDate = document.getElementById('report-end').value;

            if (!startDate || !endDate) {
                alert('Please select start and end dates');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            let y = 20;

            // Title
            doc.setFontSize(18);
            doc.text('Andy & Sons Time Report', 105, y, { align: 'center' });
            y += 10;

            doc.setFontSize(12);
            doc.text(`${formatDateDisplay(startDate)} - ${formatDateDisplay(endDate)}`, 105, y, { align: 'center' });
            y += 15;

            // Get entries in date range
            const entries = state.entries.filter(e => e.date >= startDate && e.date <= endDate)
                .sort((a, b) => a.date.localeCompare(b.date) || a.startTime.localeCompare(b.startTime));

            // Group by date
            const byDate = {};
            entries.forEach(e => {
                if (!byDate[e.date]) byDate[e.date] = [];
                byDate[e.date].push(e);
            });

            // Calculate totals by type
            const byType = {};
            let grandTotal = 0;
            entries.forEach(e => {
                const ms = parseDuration(e.startTime, e.endTime);
                if (!byType[e.type]) byType[e.type] = 0;
                byType[e.type] += ms;
                grandTotal += ms;
            });

            // Summary
            doc.setFontSize(14);
            doc.text('Summary', 20, y);
            y += 8;

            doc.setFontSize(10);
            Object.keys(byType).sort().forEach(type => {
                const hours = (byType[type] / 3600000).toFixed(2);
                doc.text(`${type}: ${hours} hrs`, 25, y);
                y += 6;
            });

            doc.setFontSize(12);
            y += 4;
            doc.text(`Total: ${(grandTotal / 3600000).toFixed(2)} hours`, 20, y);
            y += 15;

            // Daily breakdown
            doc.setFontSize(14);
            doc.text('Daily Breakdown', 20, y);
            y += 10;

            doc.setFontSize(10);
            Object.keys(byDate).sort().forEach(date => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }

                let dayTotal = 0;
                byDate[date].forEach(e => {
                    dayTotal += parseDuration(e.startTime, e.endTime);
                });

                doc.setFontSize(11);
                doc.text(`${formatDateDisplay(date)} - ${(dayTotal / 3600000).toFixed(2)} hrs`, 20, y);
                y += 6;

                doc.setFontSize(9);
                byDate[date].forEach(e => {
                    const duration = calculateDuration(e.startTime, e.endTime);
                    doc.text(`  ${e.startTime} - ${e.endTime}  |  ${e.type}  |  ${duration}`, 25, y);
                    y += 5;
                });

                if (state.dayNotes[date]) {
                    doc.setFontSize(8);
                    doc.text(`  Notes: ${state.dayNotes[date]}`, 25, y);
                    y += 5;
                }

                y += 5;
            });

            doc.save(`timecard_${startDate}_to_${endDate}.pdf`);
        }

        // ============================================
        // MIGRATION
        // ============================================
        function checkForMigration() {
            const localData = localStorage.getItem('andySonsTimecard');
            if (localData) {
                const parsed = JSON.parse(localData);
                const hasEntries = parsed.entries && parsed.entries.length > 0;
                const hasPhotos = parsed.photos && parsed.photos.length > 0;

                if (hasEntries || hasPhotos) {
                    document.getElementById('migration-banner').style.display = 'block';
                }
            }
        }

        async function migrateLocalData() {
            const localData = localStorage.getItem('andySonsTimecard');
            if (!localData) return;

            const parsed = JSON.parse(localData);

            setSyncStatus('syncing', 'Migrating...');

            try {
                // Migrate entries
                if (parsed.entries && parsed.entries.length > 0) {
                    const entriesToInsert = parsed.entries.map(e => ({
                        user_id: currentUser.id,
                        date: e.date,
                        start_time: e.startTime,
                        end_time: e.endTime,
                        work_type: e.type
                    }));

                    const { error } = await supabaseClient
                        .from('entries')
                        .insert(entriesToInsert);

                    if (error) throw error;
                }

                // Migrate day notes
                if (parsed.dayNotes && Object.keys(parsed.dayNotes).length > 0) {
                    const notesToInsert = Object.entries(parsed.dayNotes).map(([date, notes]) => ({
                        date: date,
                        notes: notes
                    }));

                    const { error } = await supabaseClient
                        .from('day_notes')
                        .upsert(notesToInsert, { onConflict: 'date' });

                    if (error) throw error;
                }

                // Migrate photos (upload base64 to storage)
                if (parsed.photos && parsed.photos.length > 0) {
                    for (const photo of parsed.photos) {
                        try {
                            // Convert base64 to blob
                            const response = await fetch(photo.data);
                            const blob = await response.blob();

                            const fileName = `${currentUser.id}/${photo.date}/${photo.id}.jpg`;

                            const { error: uploadError } = await supabaseClient
                                .storage
                                .from('photos')
                                .upload(fileName, blob, { contentType: 'image/jpeg' });

                            if (uploadError && !uploadError.message.includes('already exists')) {
                                console.error('Upload error:', uploadError);
                                continue;
                            }

                            const { error: dbError } = await supabaseClient
                                .from('photos')
                                .insert({
                                    user_id: currentUser.id,
                                    date: photo.date,
                                    note: photo.note || '',
                                    storage_path: fileName
                                });

                            if (dbError) console.error('DB error:', dbError);
                        } catch (photoError) {
                            console.error('Error migrating photo:', photoError);
                        }
                    }
                }

                // Clear local storage (keep timer state)
                localStorage.removeItem('andySonsTimecard');

                await loadStateFromSupabase();
                renderTodayEntries();
                await renderTodayPhotos();

                dismissMigration();
                setSyncStatus('synced', 'Synced');
                alert('Local data uploaded successfully!');
            } catch (error) {
                console.error('Migration error:', error);
                setSyncStatus('error', 'Error');
                alert('Error migrating data: ' + error.message);
            }
        }

        function dismissMigration() {
            document.getElementById('migration-banner').style.display = 'none';
            // Mark as dismissed
            localStorage.setItem('andySonsMigrationDismissed', 'true');
        }

        // ============================================
        // UTILITIES
        // ============================================
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function formatTime(date) {
            return date.toTimeString().slice(0, 5);
        }

        function formatDuration(ms) {
            const seconds = Math.floor(ms / 1000);
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function calculateDuration(start, end) {
            const ms = parseDuration(start, end);
            const hours = Math.floor(ms / 3600000);
            const minutes = Math.floor((ms % 3600000) / 60000);
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            }
            return `${minutes}m`;
        }

        function parseDuration(start, end) {
            const [sh, sm] = start.split(':').map(Number);
            const [eh, em] = end.split(':').map(Number);
            return ((eh * 60 + em) - (sh * 60 + sm)) * 60000;
        }

        function formatDateDisplay(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // ============================================
        // START APP
        // ============================================
        init();
    </script>
</body>
</html>
